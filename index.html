<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>AI Dictation Exercise Generator</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet">
    
    <!-- Firebase SDKs -->
    <script src="https://www.gstatic.com/firebasejs/9.6.10/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.6.10/firebase-firestore-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.6.10/firebase-auth-compat.js"></script>

    <style>
        body {
            font-family: 'Inter', sans-serif;
        }
        .loader {
            border: 4px solid #f3f3f3;
            border-top: 4px solid #3498db;
            border-radius: 50%;
            width: 40px;
            height: 40px;
            animation: spin 1s linear infinite;
        }
        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }
        .fade-in {
            animation: fadeIn 0.5s ease-in-out;
        }
        @keyframes fadeIn {
            from { opacity: 0; transform: translateY(10px); }
            to { opacity: 1; transform: translateY(0); }
        }
        input[type="text"].correct {
            border-color: #22c55e; /* green-500 */
            background-color: #f0fdf4; /* green-50 */
        }
        input[type="text"].incorrect {
            border-color: #ef4444; /* red-500 */
            background-color: #fef2f2; /* red-50 */
        }
        /* Tab styles */
        .tab-btn {
            transition: background-color 0.2s, color 0.2s, border-color 0.2s;
        }
        .tab-btn.active {
            border-color: #3b82f6; /* blue-500 */
            color: #3b82f6;
            background-color: #eff6ff; /* blue-50 */
        }
    </style>
</head>
<body class="bg-gray-50 text-gray-800 flex items-center justify-center min-h-screen p-4">

    <main class="bg-white p-6 sm:p-8 rounded-2xl shadow-lg w-full max-w-3xl space-y-6">
        <!-- Header Section -->
        <header class="text-center relative">
            <h1 class="text-3xl sm:text-4xl font-bold text-gray-900 px-20">AI Dictation Exercise Generator</h1>
            <p id="header-subtitle" class="text-gray-600 mt-2">Create and complete AI-powered dictation exercises.</p>
            <button id="logout-btn" class="hidden absolute top-0 right-0 bg-red-500 text-white py-2 px-4 rounded-lg text-sm font-semibold hover:bg-red-600 transition">Log Out</button>
        </header>

        <!-- Login Section -->
        <div id="login-section" class="hidden space-y-4 pt-4">
            <h2 class="text-2xl font-bold text-center text-gray-800">Teacher Login</h2>
            <div>
                <label for="email" class="block text-lg font-semibold text-gray-700">Email</label>
                <input type="email" id="email" class="mt-1 w-full p-3 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500" placeholder="teacher@example.com">
            </div>
            <div>
                <label for="password" class="block text-lg font-semibold text-gray-700">Password</label>
                <input type="password" id="password" class="mt-1 w-full p-3 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500">
            </div>
            <p id="login-error" class="text-red-600 text-center"></p>
            <button id="login-btn" class="w-full bg-blue-600 text-white py-3 px-6 rounded-lg font-semibold hover:bg-blue-700 transition">Log In</button>
        </div>

        <!-- Main App Content (hidden until logged in or loading an exercise) -->
        <div id="app-content" class="hidden">
            <!-- Tab Navigation -->
            <div id="tab-nav" class="border-b border-gray-200">
                <nav class="-mb-px flex space-x-4" aria-label="Tabs">
                    <button id="setup-tab-btn" class="tab-btn active whitespace-nowrap py-3 px-4 border-b-2 font-semibold text-lg text-gray-500 hover:text-blue-600 hover:border-blue-300">
                        Setup
                    </button>
                    <button id="exercise-tab-btn" class="tab-btn whitespace-nowrap py-3 px-4 border-b-2 font-semibold text-lg text-gray-500 hover:text-blue-600 hover:border-blue-300" disabled>
                        Exercise
                    </button>
                </nav>
            </div>

            <!-- Tab Content -->
            <div id="tab-content">
                <!-- Instructor Input Section (Setup Tab) -->
                <div id="setup-tab-content" class="space-y-4">
                    <div>
                        <label for="cefr-level" class="block text-lg font-semibold text-gray-700">CEFR Difficulty Level</label>
                        <select id="cefr-level" class="mt-1 w-full p-3 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-blue-500 transition">
                            <option value="A1">A1 (Beginner)</option>
                            <option value="A2">A2 (Elementary)</option>
                            <option value="B1" selected>B1 (Intermediate)</option>
                            <option value="B2">B2 (Upper-Intermediate)</option>
                            <option value="C1">C1 (Advanced)</option>
                        </select>
                    </div>
                    <div>
                        <label for="keywords" class="block text-lg font-semibold text-gray-700">Keywords & Phrases</label>
                        <textarea id="keywords" rows="3" class="mt-1 w-full p-3 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-blue-500 transition" placeholder="e.g., renewable energy, solar panels, sustainability, carbon footprint"></textarea>
                        <p class="text-sm text-gray-500">Separate words or phrases with a comma.</p>
                    </div>
                    <button id="generate-btn" class="w-full bg-blue-600 text-white py-3 px-6 rounded-lg font-semibold hover:bg-blue-700 focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-blue-500 transition transform hover:scale-105 active:scale-100 disabled:bg-gray-400 disabled:cursor-not-allowed disabled:transform-none">
                        Generate Exercise
                    </button>
                </div>

                <!-- Student Exercise Section (Exercise Tab) -->
                <div id="exercise-tab-content" class="hidden space-y-4 fade-in">
                    <!-- Audio Player -->
                    <div>
                        <p class="text-lg font-semibold mb-2 text-gray-700">Listen to the passage:</p>
                        <audio id="audio-player" controls class="w-full"></audio>
                    </div>
                    <!-- Dictation Passage with Blanks -->
                    <div>
                        <p class="text-lg font-semibold mb-2 text-gray-700">Fill in the blanks:</p>
                        <div id="passage-container" class="text-lg leading-relaxed bg-gray-100 p-4 rounded-lg space-y-2"></div>
                    </div>
                    <!-- Action Buttons -->
                    <div class="flex flex-col sm:flex-row gap-4 pt-4">
                        <button id="check-answers-btn" class="w-full bg-green-600 text-white py-3 px-6 rounded-lg font-semibold hover:bg-green-700 transition">Check Answers</button>
                        <button id="share-btn" class="w-full bg-indigo-600 text-white py-3 px-6 rounded-lg font-semibold hover:bg-indigo-700 transition">Share Exercise</button>
                        <button id="start-over-btn" class="w-full bg-gray-600 text-white py-3 px-6 rounded-lg font-semibold hover:bg-gray-700 transition">Start Over</button>
                    </div>
                    <!-- Results Display -->
                    <div id="results-container" class="hidden mt-4 p-4 bg-blue-50 border-blue-200 rounded-lg">
                        <p id="results-text" class="text-center font-medium text-blue-800"></p>
                    </div>
                    <!-- Share Confirmation -->
                    <div id="share-confirmation" class="hidden mt-4 p-4 bg-green-50 border-green-200 rounded-lg">
                        <p class="text-center font-medium text-green-800">Shareable link copied to clipboard!</p>
                    </div>
                </div>
            </div>
        </div>

        <!-- Loading Indicator -->
        <div id="loader-container" class="hidden flex-col items-center justify-center space-y-2 text-center py-10">
            <div class="loader"></div>
            <p class="text-gray-600 font-medium">Loading...</p>
        </div>
        
        <!-- Error Message Box -->
        <div id="error-box" class="hidden p-4 bg-red-100 border-red-400 text-red-700 rounded-lg">
            <p id="error-message"></p>
        </div>

    </main>

    <script type="module">
        // --- DOM Element References ---
        const loginSection = document.getElementById('login-section');
        const appContent = document.getElementById('app-content');
        const loginBtn = document.getElementById('login-btn');
        const logoutBtn = document.getElementById('logout-btn');
        const emailInput = document.getElementById('email');
        const passwordInput = document.getElementById('password');
        const loginError = document.getElementById('login-error');
        const generateBtn = document.getElementById('generate-btn');
        const keywordsInput = document.getElementById('keywords');
        const cefrLevelSelect = document.getElementById('cefr-level');
        const loaderContainer = document.getElementById('loader-container');
        const errorBox = document.getElementById('error-box');
        const errorMessage = document.getElementById('error-message');
        const passageContainer = document.getElementById('passage-container');
        const audioPlayer = document.getElementById('audio-player');
        const checkAnswersBtn = document.getElementById('check-answers-btn');
        const startOverBtn = document.getElementById('start-over-btn');
        const shareBtn = document.getElementById('share-btn');
        const resultsContainer = document.getElementById('results-container');
        const resultsText = document.getElementById('results-text');
        const shareConfirmation = document.getElementById('share-confirmation');
        const setupTabBtn = document.getElementById('setup-tab-btn');
        const exerciseTabBtn = document.getElementById('exercise-tab-btn');
        const setupTabContent = document.getElementById('setup-tab-content');
        const exerciseTabContent = document.getElementById('exercise-tab-content');
        const tabContentContainer = document.getElementById('tab-content');
        const tabNav = document.getElementById('tab-nav');

        let currentExercise = {};

        // --- Firebase Configuration ---
        const firebaseConfig = {
            apiKey: "AIzaSyDkeKjf4XuVU6bTdDw5eMArO6XFTXH1V1o",
            authDomain: "listening-4a199.firebaseapp.com",
            projectId: "listening-4a199",
            storageBucket: "listening-4a199.appspot.com",
            messagingSenderId: "44749070449",
            appId: "1:44749070449:web:8a347a0c4b2be232b9fbd0",
            measurementId: "G-F7XPVVPEXR"
        };

        // Initialize Firebase
        const app = firebase.initializeApp(firebaseConfig);
        const db = firebase.firestore();
        const auth = firebase.auth();

        // --- API Configuration ---
        const API_KEY = "AIzaSyAQd6t3l6Dg9_Vc5LdMEcbnRVE0Cr5ndnY"; // Kept for local testing if needed, but generation is now restricted.
        const TEXT_API_URL = `https://generativelanguage.googleapis.com/v1beta/models/gemini-2.5-flash-preview-05-20:generateContent?key=${API_KEY}`;
        const TTS_API_URL = `https://generativelanguage.googleapis.com/v1beta/models/gemini-2.5-flash-preview-tts:generateContent?key=${API_KEY}`;
        
        // --- Core App Logic ---

        auth.onAuthStateChanged(async user => {
            const params = new URLSearchParams(window.location.search);
            const exerciseId = params.get('exercise');

            if (user) { // User is logged in
                loginSection.classList.add('hidden');
                appContent.classList.remove('hidden');
                logoutBtn.classList.remove('hidden');
                setupTabBtn.classList.remove('hidden');
                shareBtn.classList.remove('hidden');
                
                if (!exerciseId) {
                    switchTab('setup');
                } else {
                    await loadFromUrl();
                }

            } else { // User is logged out
                logoutBtn.classList.add('hidden');
                if (exerciseId) {
                    appContent.classList.remove('hidden');
                    loginSection.classList.add('hidden');
                    setupTabBtn.classList.add('hidden'); // Hide setup for non-logged-in users
                    shareBtn.classList.add('hidden'); // Hide share for non-logged-in users
                    await loadFromUrl();
                } else {
                    appContent.classList.add('hidden');
                    loginSection.classList.remove('hidden');
                }
            }
        });

        async function handleLogin() {
            const email = emailInput.value;
            const password = passwordInput.value;
            loginError.textContent = '';
            try {
                await auth.signInWithEmailAndPassword(email, password);
            } catch (error) {
                console.error("Login failed:", error);
                if (error.code === 'auth/invalid-login-credentials' || error.code === 'auth/wrong-password' || error.code === 'auth/user-not-found') {
                    loginError.textContent = 'Incorrect email or password. Please try again.';
                } else {
                    loginError.textContent = 'An unexpected error occurred. Please try again later.';
                }
            }
        }

        async function handleLogout() {
            await auth.signOut();
            handleStartOver(); // Reset the UI to a clean state
        }
        
        async function fetchWithBackoff(url, payload, maxRetries = 3) {
            let attempt = 0;
            while (attempt < maxRetries) {
                try {
                    const response = await fetch(url, {
                        method: 'POST',
                        headers: { 'Content-Type': 'application/json' },
                        body: JSON.stringify(payload),
                    });
                    if (!response.ok) throw new Error(`API Error: ${response.status}`);
                    return await response.json();
                } catch (error) {
                    attempt++;
                    if (attempt >= maxRetries) throw error;
                    await new Promise(resolve => setTimeout(resolve, Math.pow(2, attempt) * 1000));
                }
            }
        }

        async function generatePassage(keywords, level) {
            const payload = {
                contents: [{ parts: [{ text: `Generate a single paragraph at CEFR level ${level} that includes: "${keywords.join('", "')}".` }] }],
                systemInstruction: { parts: [{ text: `You are an English teacher... Generate a short, clear paragraph for an English learner at the ${level} CEFR level... The passage must incorporate: "${keywords.join('", "')}". Do not use markdown.` }] },
                generationConfig: { temperature: 0.7, maxOutputTokens: 500 },
                safetySettings: [{ category: "HARM_CATEGORY_HARASSMENT", threshold: "BLOCK_NONE" }, { category: "HARM_CATEGORY_HATE_SPEECH", threshold: "BLOCK_NONE" }, { category: "HARM_CATEGORY_SEXUALLY_EXPLICIT", threshold: "BLOCK_NONE" }, { category: "HARM_CATEGORY_DANGEROUS_CONTENT", threshold: "BLOCK_NONE" }]
            };
            const result = await fetchWithBackoff(TEXT_API_URL, payload);
            const text = result.candidates?.[0]?.content?.parts?.[0]?.text;
            if (!text) throw new Error("Failed to generate a valid passage.");
            return text.trim();
        }

        async function generateAudio(text) {
            const payload = {
                contents: [{ parts: [{ text: `Read this passage clearly: ${text}` }] }],
                generationConfig: { responseModalities: ["AUDIO"], speechConfig: { voiceConfig: { prebuiltVoiceConfig: { voiceName: "Kore" } } } },
                model: "gemini-2.5-flash-preview-tts",
                safetySettings: [{ category: "HARM_CATEGORY_HARASSMENT", threshold: "BLOCK_NONE" }, { category: "HARM_CATEGORY_HATE_SPEECH", threshold: "BLOCK_NONE" }, { category: "HARM_CATEGORY_SEXUALLY_EXPLICIT", threshold: "BLOCK_NONE" }, { category: "HARM_CATEGORY_DANGEROUS_CONTENT", threshold: "BLOCK_NONE" }]
            };
            const result = await fetchWithBackoff(TTS_API_URL, payload);
            const audioData = result.candidates?.[0]?.content?.parts?.[0]?.inlineData?.data;
            if (!audioData) throw new Error("Failed to generate valid audio data.");
            return audioData;
        }
        
        async function saveExercise(exerciseData) {
            const docRef = await db.collection("exercises").add(exerciseData);
            return docRef.id;
        }

        async function loadExercise(id) {
            const doc = await db.collection("exercises").doc(id).get();
            if (doc.exists) return doc.data();
            throw new Error("Exercise not found.");
        }

        function base64ToArrayBuffer(base64) {
            const binaryString = window.atob(base64), len = binaryString.length, bytes = new Uint8Array(len);
            for (let i = 0; i < len; i++) bytes[i] = binaryString.charCodeAt(i);
            return bytes.buffer;
        }
        
        function pcmToWav(pcmData, sampleRate) {
            const numChannels = 1, bitsPerSample = 16, blockAlign = (numChannels * bitsPerSample) / 8, byteRate = sampleRate * blockAlign, dataSize = pcmData.length * (bitsPerSample / 8), buffer = new ArrayBuffer(44 + dataSize), view = new DataView(buffer);
            writeString(view, 0, 'RIFF'); view.setUint32(4, 36 + dataSize, true); writeString(view, 8, 'WAVE'); writeString(view, 12, 'fmt '); view.setUint32(16, 16, true); view.setUint16(20, 1, true); view.setUint16(22, numChannels, true); view.setUint32(24, sampleRate, true); view.setUint32(28, byteRate, true); view.setUint16(32, blockAlign, true); view.setUint16(34, bitsPerSample, true); writeString(view, 36, 'data'); view.setUint32(40, dataSize, true);
            let offset = 44;
            for (let i = 0; i < pcmData.length; i++, offset += 2) view.setInt16(offset, pcmData[i], true);
            return new Blob([view], { type: 'audio/wav' });
        }
        
        function writeString(view, offset, string) {
            for (let i = 0; i < string.length; i++) view.setUint8(offset + i, string.charCodeAt(i));
        }

        function createDictationUI(passage, keywords) {
            const sortedKeywords = [...keywords].sort((a, b) => b.length - a.length);
            let passageHTML = passage;
            const regex = new RegExp(`(${sortedKeywords.map(kw => kw.replace(/[-\/\\^$*+?.()|[\]{}]/g, '\\$&')).join('|')})`, 'gi');
            passageHTML = passageHTML.replace(regex, (match) => {
                const originalKw = keywords.find(kw => kw.toLowerCase() === match.toLowerCase());
                const inputWidth = Math.max(originalKw.length * 10, 80);
                return `<input type="text" data-answer="${originalKw}" class="dictation-blank border-b-2 border-gray-400 focus:border-blue-500 outline-none bg-transparent text-center transition mx-1" style="width: ${inputWidth}px;">`;
            });
            passageContainer.innerHTML = `<p>${passageHTML}</p>`;
        }

        function switchTab(tabName) {
            const isSetup = tabName === 'setup';
            setupTabBtn.classList.toggle('active', isSetup);
            exerciseTabBtn.classList.toggle('active', !isSetup);
            setupTabContent.classList.toggle('hidden', !isSetup);
            exerciseTabContent.classList.toggle('hidden', isSetup);
        }
        
        function setLoadingState(isLoading, message = "Loading...") {
            tabContentContainer.classList.toggle('hidden', isLoading);
            appContent.classList.toggle('hidden', isLoading);
            loginSection.classList.add('hidden');
            loaderContainer.querySelector('p').textContent = message;
            loaderContainer.classList.toggle('hidden', !isLoading);
            errorBox.classList.add('hidden');
            generateBtn.disabled = isLoading;
        }
        
        async function handleGenerateClick() {
            const keywordsText = keywordsInput.value.trim();
            if (!keywordsText) { showError("Please enter keywords."); return; }
            const keywords = keywordsText.split(',').map(kw => kw.trim()).filter(Boolean);
            if (keywords.length === 0) { showError("Please enter valid keywords."); return; }
            const selectedLevel = cefrLevelSelect.value;
            setLoadingState(true, "Generating your dictation exercise...");
            try {
                const passage = await generatePassage(keywords, selectedLevel);
                await setupExercise(passage.replace(/\*/g, ''), keywords, selectedLevel);
            } catch (error) {
                console.error("Error during generation:", error);
                showError(error.message || "An unknown error occurred.");
                setLoadingState(false);
            }
        }

        async function setupExercise(passage, keywords, cefrLevel) {
            currentExercise = { passage, keywords, cefrLevel };
            const audioData = await generateAudio(passage);
            createDictationUI(passage, keywords);
            const pcmBuffer = base64ToArrayBuffer(audioData);
            const pcm16 = new Int16Array(pcmBuffer);
            const wavBlob = pcmToWav(pcm16, 24000);
            audioPlayer.src = URL.createObjectURL(wavBlob);
            setLoadingState(false);
            exerciseTabBtn.disabled = false;
            switchTab('exercise');
        }

        function handleCheckAnswers() {
            const inputs = passageContainer.querySelectorAll('.dictation-blank');
            let correctCount = 0;
            inputs.forEach(input => {
                if (input.value.trim().toLowerCase() === input.dataset.answer.toLowerCase()) {
                    input.classList.add('correct'); correctCount++;
                } else {
                    input.classList.add('incorrect');
                }
            });
            resultsText.textContent = `You got ${correctCount} out of ${inputs.length} correct!`;
            resultsContainer.classList.remove('hidden');
        }
        
        async function handleShareClick() {
            try {
                const exerciseId = await saveExercise(currentExercise);
                const shareUrl = `${window.location.href.split('?')[0]}?exercise=${exerciseId}`;
                const textArea = document.createElement("textarea");
                textArea.value = shareUrl;
                document.body.appendChild(textArea);
                textArea.select();
                document.execCommand("copy");
                document.body.removeChild(textArea);
                shareConfirmation.classList.remove('hidden');
                setTimeout(() => shareConfirmation.classList.add('hidden'), 3000);
            } catch (error) {
                console.error("Error sharing exercise:", error);
                showError("Could not save or copy the exercise link.");
            }
        }

        function handleStartOver() {
            if (auth.currentUser) {
                switchTab('setup');
            } else {
                appContent.classList.add('hidden');
                loginSection.classList.remove('hidden');
            }
            keywordsInput.value = '';
            passageContainer.innerHTML = '';
            audioPlayer.src = '';
            currentExercise = {};
            exerciseTabBtn.disabled = true;
            exerciseTabBtn.classList.remove('active');
            resultsContainer.classList.add('hidden');
            shareConfirmation.classList.add('hidden');
            cefrLevelSelect.value = 'B1';
            try {
                window.history.pushState({}, '', window.location.pathname);
            } catch (e) {
                console.warn("Could not clear URL history:", e);
                // In sandboxed environments, this might fail. We can ignore it.
            }
        }
        
        function showError(message) {
            errorMessage.textContent = message;
            errorBox.classList.remove('hidden');
            appContent.classList.add('hidden');
            loginSection.classList.add('hidden');
        }

        async function loadFromUrl() {
            const params = new URLSearchParams(window.location.search);
            const exerciseId = params.get('exercise');
            if (exerciseId) {
                setLoadingState(true);
                try {
                    const exerciseData = await loadExercise(exerciseId);
                    await setupExercise(exerciseData.passage, exerciseData.keywords, exerciseData.cefrLevel);
                } catch (error) {
                    console.error("Error loading from URL:", error);
                    showError("Could not load the shared exercise.");
                    setLoadingState(false);
                }
            }
        }

        // --- Attach Event Listeners ---
        loginBtn.addEventListener('click', handleLogin);
        logoutBtn.addEventListener('click', handleLogout);
        generateBtn.addEventListener('click', handleGenerateClick);
        checkAnswersBtn.addEventListener('click', handleCheckAnswers);
        shareBtn.addEventListener('click', handleShareClick);
        startOverBtn.addEventListener('click', handleStartOver);
        setupTabBtn.addEventListener('click', () => switchTab('setup'));
        exerciseTabBtn.addEventListener('click', () => switchTab('exercise'));
    </script>
</body>
</html>
